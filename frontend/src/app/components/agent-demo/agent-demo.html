<div class="agent-demo-container">
  <h1>React Agent Demo</h1>

  <!-- HEALTH STATUS -->
  <div class="health-status">
    <strong>Backend Status:</strong>
    <span [class.healthy]="healthStatus === 'healthy'" [class.unhealthy]="healthStatus !== 'healthy'">
      {{ healthStatus || "checking..." }}
    </span>
  </div>

  <!-- TOOLS LIST -->
  <div class="section">
    <h2>
      Available Tools
      <button class="link-button" (click)="showTools = !showTools">
        {{ showTools ? "Hide" : "Show" }}
      </button>
    </h2>

    @if (showTools) {
      <ul class="tools-list simple-list">
        @for (tool of tools; track tool.name) {
          <li class="tool-item">
            <div class="tool-name">{{ tool.name }}</div>
            <div class="tool-desc">{{ tool.description }}</div>
          </li>
        }
      </ul>
    }
  </div>

  <!-- RUBRIC UPLOAD -->
  <div class="section upload-section">
    <h3>
      @if (rubricUploadResponse) {
        Upload Rubric: {{ rubricUploadResponse.filename }}
      } @else {
        Upload Rubric
      }
    </h3>

    <div class="upload-box">
      <input type="file" class="upload-input" (change)="onRubricSelected($event)" />
      <button class="upload-button">Choose File</button>
    </div>
  </div>

  <!-- RUBRIC CRITERIA -->
  @if (rubricSchema) {
    <div class="section">
      <h3>Select Rubric Criteria</h3>

      @for (item of rubricSchema.rubric_items; track item.id) {
        <div class="rubric-accordion">
          <div class="rubric-header" (click)="expandedRubric[item.id] = !expandedRubric[item.id]">
            <div class="rubric-title">
              <input
                type="checkbox"
                [(ngModel)]="rubricSelections[item.id]"
                (click)="$event.stopPropagation()"
              />
              <strong>{{ item.label }}</strong>
            </div>

            <div class="arrow" [class.open]="expandedRubric[item.id]">▼</div>
          </div>

          @if (expandedRubric[item.id]) {
            <div class="rubric-body">
              <p><strong>Max Points:</strong> {{ item.max_points }}</p>
              <p>{{ item.description }}</p>

              @if (item.items) {
                <ul>
                  @for (sub of item.items; track sub) {
                    <li>{{ sub }}</li>
                  }
                </ul>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- SUBMISSION REPO INPUT -->
    <div class="section upload-section">
      <h3 class="upload-title">Upload Submission</h3>

      <div class="upload-box pretty-upload-box">
        <input
          type="url"
          [(ngModel)]="submissionRepoUrl"
          placeholder="https://github.com/username/repo"
          class="upload-input-field"
        />

        <button class="upload-button" (click)="submitGithubUrl()">Load Repository</button>
      </div>

      @if (submissionUploadResponse) {
        <div class="upload-status success-status">
          <strong>Repository Cloned:</strong>
          <span>{{ submissionUploadResponse.project_path }}</span>
        </div>
      }
    </div>
  }

  <!-- RUN TESTS -->
  <div class="section">
    <h2>Run Tests</h2>

    <div class="task-form">
      <div class="form-group">
        <label>Max Iterations:</label>
        <input
          type="number"
          [(ngModel)]="maxIterations"
          min="1"
          max="20"
          [disabled]="isLoading"
        />
      </div>

      <button
        (click)="runTask()"
        [disabled]="isLoading || !anySelected() || !submissionUploadResponse"
      >
        {{ isLoading ? "Running..." : "Run Task" }}
      </button>

      <button
        class="stop-button"
        (click)="stopTask()"
        [disabled]="!isLoading"
      >
        Stop
      </button>

    </div>

    @if (error) {
      <div class="error">{{ error }}</div>
    }

    <!-- MULTI-AGENT RESULTS -->
    @if (multiAgentResults?.length > 0) {
      <div class="section">
        <h2>Results</h2>

        <!-- FINAL GRADE CARD -->
        @if (parsedOutput) {
          <div class="grade-and-result">

            <div class="grade-card">
              <div class="grade-left">
                <div class="score-circle" [ngClass]="scoreColorClass(getPercentage())">
                  <div class="score-text">
                    {{ getPercentage() !== null ? getPercentage() + '%' : '—' }}
                  </div>
                </div>
              </div>

              <div class="grade-right">
                <div class="summary">
                  <div class="summary-title">{{ parsedOutput.summary }}</div>
                </div>

                <div class="score-row">
                  <div class="score-values">
                    {{ parsedOutput.total_score }} / {{ parsedOutput.max_score }} pts
                  </div>

                  <div class="actions">
                    <button class="small-button" (click)="viewRaw = !viewRaw">
                      {{ viewRaw ? "Hide raw" : "View raw" }}
                    </button>

                    <button class="small-button" (click)="copyToClipboard(prettyObservation(parsedOutput))">
                      Copy JSON
                    </button>
                  </div>
                </div>
              </div>
            </div>

            @if (viewRaw) {
              <div class="raw-block">
                <pre>{{ prettyObservation(parsedOutput) }}</pre>
              </div>
            }
          </div>
        }

        <div class="multi-agent-grid">
          @for (item of multiAgentResults; track item.rubric_item) {

            <!-- Each Rubric Item Card -->
            <div class="agent-card">
              <h3>{{ item.rubric_item | titlecase }}</h3>

              <p><strong>Score:</strong>
                {{ item.parsed?.total_score ?? "—" }}
                /
                {{ item.parsed?.max_score ?? "—" }}
              </p>

              <p><strong>Feedback:</strong></p>
              <pre class="feedback-block">
{{ item.parsed?.breakdown?.[item.rubric_item]?.feedback || "No feedback." }}
              </pre>

              <details>
                <summary>Show raw output</summary>
                <pre>{{ item | json }}</pre>
              </details>

              <details>
                <summary>Agent Steps</summary>
                @for (step of item.steps; track step) {
                  <p><strong>Tool:</strong> {{ step.action?.tool }}</p>
                  <p><strong>Observation:</strong></p>
                  <pre>{{ prettyObservation(step.observation) }}</pre>
                }
              </details>
            </div>
          }
        </div>
      </div>
    }
  </div>
</div>